// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  // Supporte SQLite (dev) et PostgreSQL (prod)
  // Pour PostgreSQL: provider = "postgresql"
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// ============================================
// UTILISATEURS ET AUTHENTIFICATION
// ============================================

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  password      String
  firstName     String
  lastName      String
  avatar        String?
  role          String    @default("LEARNER")  // LEARNER, INSTRUCTOR, ADMIN
  bio           String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  lastLoginAt   DateTime?
  isActive      Boolean   @default(true)

  // 2FA Fields
  twoFactorEnabled  Boolean   @default(false)
  twoFactorSecret   String?
  twoFactorBackupCodes String? // JSON array of backup codes

  // Relations
  enrollments       Enrollment[]
  courseProgress    CourseProgress[]
  lessonProgress    LessonProgress[]
  quizAttempts      QuizAttempt[]
  certificates      Certificate[]
  badges            UserBadge[]
  notifications     Notification[]
  createdCourses    Course[]          @relation("CourseAuthor")
  forumPosts        ForumPost[]
  forumComments     ForumComment[]
  notes             Note[]
  bookmarks         Bookmark[]
  auditLogs         AuditLog[]
  forumVotes        ForumVote[]
  sessions          UserSession[]
  preferences       UserPreference?

  @@index([email])
  @@index([role])
}

// Role values: LEARNER, INSTRUCTOR, ADMIN

// ============================================
// COURS ET MODULES
// ============================================

model Course {
  id              String    @id @default(cuid())
  title           String
  slug            String    @unique
  description     String
  shortDescription String?
  thumbnail       String?
  duration        Int       @default(0)  // en minutes
  level           String    @default("BEGINNER")  // BEGINNER, INTERMEDIATE, ADVANCED, EXPERT
  category        String
  tags            String?   // JSON array stored as string
  price           Float     @default(0)
  isFree          Boolean   @default(true)
  isPublished     Boolean   @default(false)
  isFeatured      Boolean   @default(false)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  publishedAt     DateTime?

  // Relations
  authorId        String
  author          User      @relation("CourseAuthor", fields: [authorId], references: [id])
  modules         Module[]
  enrollments     Enrollment[]
  courseProgress  CourseProgress[]
  certificates    Certificate[]
  reviews         Review[]
  forumPosts      ForumPost[]

  @@index([slug])
  @@index([category])
  @@index([isPublished])
}

// Level values: BEGINNER, INTERMEDIATE, ADVANCED, EXPERT

model Module {
  id          String   @id @default(cuid())
  title       String
  description String?
  order       Int
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  courseId    String
  course      Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
  lessons     Lesson[]

  @@index([courseId])
}

model Lesson {
  id          String      @id @default(cuid())
  title       String
  description String?
  content     String?     // HTML/Markdown content
  videoUrl    String?
  duration    Int         @default(0)  // en minutes
  order       Int
  type        String      @default("TEXT")  // TEXT, VIDEO, QUIZ, ASSIGNMENT, INTERACTIVE
  isPreview   Boolean     @default(false)
  resources   String?     // JSON array for downloadable resources
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  // Relations
  moduleId        String
  module          Module          @relation(fields: [moduleId], references: [id], onDelete: Cascade)
  lessonProgress  LessonProgress[]
  quiz            Quiz?
  notes           Note[]
  bookmarks       Bookmark[]

  @@index([moduleId])
}

// LessonType values: TEXT, VIDEO, QUIZ, ASSIGNMENT, INTERACTIVE

// ============================================
// PROGRESSION ET INSCRIPTIONS
// ============================================

model Enrollment {
  id           String           @id @default(cuid())
  enrolledAt   DateTime         @default(now())
  completedAt  DateTime?
  status       String           @default("ACTIVE")  // ACTIVE, COMPLETED, PAUSED, CANCELLED

  // Relations
  userId       String
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  courseId     String
  course       Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)

  @@unique([userId, courseId])
  @@index([userId])
  @@index([courseId])
}

// EnrollmentStatus values: ACTIVE, COMPLETED, PAUSED, CANCELLED

model CourseProgress {
  id                String   @id @default(cuid())
  progressPercent   Float    @default(0)
  lastAccessedAt    DateTime @default(now())
  timeSpent         Int      @default(0)  // en minutes
  updatedAt         DateTime @updatedAt

  // Relations
  userId            String
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  courseId          String
  course            Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)

  @@unique([userId, courseId])
  @@index([userId])
  @@index([courseId])
}

model LessonProgress {
  id           String   @id @default(cuid())
  isCompleted  Boolean  @default(false)
  completedAt  DateTime?
  timeSpent    Int      @default(0)  // en secondes
  lastPosition Int      @default(0)  // pour les vidéos, en secondes

  // Relations
  userId       String
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  lessonId     String
  lesson       Lesson   @relation(fields: [lessonId], references: [id], onDelete: Cascade)

  @@unique([userId, lessonId])
  @@index([userId])
  @@index([lessonId])
}

// ============================================
// QUIZ ET ÉVALUATIONS
// ============================================

model Quiz {
  id              String   @id @default(cuid())
  title           String
  description     String?
  passingScore    Int      @default(70)  // pourcentage
  timeLimit       Int?     // en minutes, null = pas de limite
  maxAttempts     Int      @default(3)
  shuffleQuestions Boolean @default(true)
  showCorrectAnswers Boolean @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  lessonId        String   @unique
  lesson          Lesson   @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  questions       Question[]
  attempts        QuizAttempt[]
}

model Question {
  id          String       @id @default(cuid())
  text        String
  type        String       @default("MULTIPLE_CHOICE")  // MULTIPLE_CHOICE, SINGLE_CHOICE, TRUE_FALSE, SHORT_ANSWER, FILL_BLANK
  explanation String?
  points      Int          @default(1)
  order       Int

  // Relations
  quizId      String
  quiz        Quiz         @relation(fields: [quizId], references: [id], onDelete: Cascade)
  answers     Answer[]

  @@index([quizId])
}

// QuestionType values: MULTIPLE_CHOICE, SINGLE_CHOICE, TRUE_FALSE, SHORT_ANSWER, FILL_BLANK

model Answer {
  id          String  @id @default(cuid())
  text        String
  isCorrect   Boolean @default(false)
  order       Int

  // Relations
  questionId  String
  question    Question @relation(fields: [questionId], references: [id], onDelete: Cascade)

  @@index([questionId])
}

model QuizAttempt {
  id            String   @id @default(cuid())
  score         Float
  maxScore      Float
  percentage    Float
  isPassed      Boolean
  timeSpent     Int      // en secondes
  answers       String   // JSON des réponses
  startedAt     DateTime @default(now())
  completedAt   DateTime @default(now())

  // Relations
  userId        String
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  quizId        String
  quiz          Quiz     @relation(fields: [quizId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([quizId])
}

// ============================================
// CERTIFICATS ET BADGES (GAMIFICATION)
// ============================================

model Certificate {
  id            String   @id @default(cuid())
  certificateNumber String @unique
  issuedAt      DateTime @default(now())
  expiresAt     DateTime?

  // Relations
  userId        String
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  courseId      String
  course        Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)

  @@unique([userId, courseId])
  @@index([certificateNumber])
}

model Badge {
  id          String      @id @default(cuid())
  name        String      @unique
  description String
  icon        String
  criteria    String      // JSON des critères d'obtention
  points      Int         @default(0)
  category    String        @default("ACHIEVEMENT")  // ACHIEVEMENT, MILESTONE, SKILL, SPECIAL
  createdAt   DateTime    @default(now())

  // Relations
  userBadges  UserBadge[]
}

// BadgeCategory values: ACHIEVEMENT, MILESTONE, SKILL, SPECIAL

model UserBadge {
  id        String   @id @default(cuid())
  earnedAt  DateTime @default(now())

  // Relations
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  badgeId   String
  badge     Badge    @relation(fields: [badgeId], references: [id], onDelete: Cascade)

  @@unique([userId, badgeId])
  @@index([userId])
}

// ============================================
// FORUM ET DISCUSSIONS
// ============================================

model ForumPost {
  id              String   @id @default(cuid())
  title           String
  content         String
  isPinned        Boolean  @default(false)
  isLocked        Boolean  @default(false)
  isSolved        Boolean  @default(false)
  views           Int      @default(0)
  voteScore       Int      @default(0)
  acceptedAnswerId String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  authorId  String
  author    User     @relation(fields: [authorId], references: [id], onDelete: Cascade)
  courseId  String
  course    Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
  comments  ForumComment[]
  votes     ForumVote[]
  tags      ForumPostTag[]

  @@index([authorId])
  @@index([courseId])
  @@index([voteScore])
  @@index([isSolved])
}

model ForumComment {
  id          String   @id @default(cuid())
  content     String
  isAccepted  Boolean  @default(false)
  voteScore   Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  authorId  String
  author    User     @relation(fields: [authorId], references: [id], onDelete: Cascade)
  postId    String
  post      ForumPost @relation(fields: [postId], references: [id], onDelete: Cascade)
  parentId  String?
  parent    ForumComment? @relation("CommentReplies", fields: [parentId], references: [id])
  replies   ForumComment[] @relation("CommentReplies")
  votes     ForumVote[]

  @@index([authorId])
  @@index([postId])
  @@index([voteScore])
}

// ============================================
// AVIS ET NOTES
// ============================================

model Review {
  id        String   @id @default(cuid())
  rating    Int      // 1-5
  comment   String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  courseId  String
  course    Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)

  @@index([courseId])
}

// ============================================
// NOTES ET FAVORIS
// ============================================

model Note {
  id        String   @id @default(cuid())
  content   String
  timestamp Int?     // pour les notes liées à une position vidéo
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  lessonId  String
  lesson    Lesson   @relation(fields: [lessonId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([lessonId])
}

model Bookmark {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  // Relations
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  lessonId  String
  lesson    Lesson   @relation(fields: [lessonId], references: [id], onDelete: Cascade)

  @@unique([userId, lessonId])
  @@index([userId])
}

// ============================================
// NOTIFICATIONS
// ============================================

model Notification {
  id        String           @id @default(cuid())
  title     String
  message   String
  type      String           @default("INFO")  // INFO, SUCCESS, WARNING, ACHIEVEMENT, COURSE_UPDATE, REMINDER
  isRead    Boolean          @default(false)
  link      String?
  createdAt DateTime         @default(now())

  // Relations
  userId    String
  user      User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([isRead])
}

// NotificationType values: INFO, SUCCESS, WARNING, ACHIEVEMENT, COURSE_UPDATE, REMINDER

// ============================================
// SÉCURITÉ ET AUDIT
// ============================================

model AuditLog {
  id          String   @id @default(cuid())
  action      String   // LOGIN, LOGOUT, CREATE, UPDATE, DELETE, EXPORT, etc.
  entityType  String   // USER, COURSE, ENROLLMENT, etc.
  entityId    String?
  details     String?  // JSON avec détails supplémentaires
  ipAddress   String?
  userAgent   String?
  createdAt   DateTime @default(now())

  // Relations
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([action])
  @@index([entityType])
  @@index([createdAt])
}

model UserSession {
  id          String   @id @default(cuid())
  token       String   @unique
  ipAddress   String?
  userAgent   String?
  isValid     Boolean  @default(true)
  createdAt   DateTime @default(now())
  expiresAt   DateTime
  lastUsedAt  DateTime @default(now())

  // Relations
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@index([expiresAt])
}

model RateLimitAttempt {
  id          String   @id @default(cuid())
  identifier  String   // IP address or user ID
  endpoint    String   // API endpoint
  attempts    Int      @default(1)
  firstAttempt DateTime @default(now())
  lastAttempt DateTime @default(now())
  blocked     Boolean  @default(false)
  blockedUntil DateTime?

  @@unique([identifier, endpoint])
  @@index([identifier])
  @@index([blocked])
}

// ============================================
// PRÉFÉRENCES UTILISATEUR
// ============================================

model UserPreference {
  id                    String   @id @default(cuid())
  theme                 String   @default("system") // light, dark, system
  language              String   @default("fr")
  emailNotifications    Boolean  @default(true)
  pushNotifications     Boolean  @default(false)
  weeklyDigest          Boolean  @default(true)
  courseReminders       Boolean  @default(true)
  marketingEmails       Boolean  @default(false)
  updatedAt             DateTime @updatedAt

  // Relations
  userId                String   @unique
  user                  User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

// ============================================
// FORUM AMÉLIORÉ (Q&A Style)
// ============================================

model ForumVote {
  id        String   @id @default(cuid())
  value     Int      // 1 for upvote, -1 for downvote
  createdAt DateTime @default(now())

  // Relations
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  postId    String?
  post      ForumPost? @relation(fields: [postId], references: [id], onDelete: Cascade)
  commentId String?
  comment   ForumComment? @relation(fields: [commentId], references: [id], onDelete: Cascade)

  @@unique([userId, postId])
  @@unique([userId, commentId])
  @@index([postId])
  @@index([commentId])
}

model ForumTag {
  id          String   @id @default(cuid())
  name        String   @unique
  slug        String   @unique
  description String?
  color       String   @default("#6366f1")
  usageCount  Int      @default(0)
  createdAt   DateTime @default(now())

  // Relations
  posts       ForumPostTag[]

  @@index([slug])
}

model ForumPostTag {
  id        String   @id @default(cuid())

  // Relations
  postId    String
  post      ForumPost @relation(fields: [postId], references: [id], onDelete: Cascade)
  tagId     String
  tag       ForumTag  @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@unique([postId, tagId])
}

// ============================================
// RECOMMANDATIONS ET PARCOURS ADAPTATIFS
// ============================================

model LearnerProfile {
  id              String   @id @default(cuid())
  userId          String   @unique
  skillLevel      String   @default("BEGINNER") // BEGINNER, INTERMEDIATE, ADVANCED, EXPERT
  learningStyle   String?  // VISUAL, AUDITORY, READING, KINESTHETIC
  preferredPace   String   @default("NORMAL") // SLOW, NORMAL, FAST
  goals           String?  // JSON array of learning goals
  interests       String?  // JSON array of topic interests
  weeklyTimeGoal  Int      @default(5) // hours per week
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([userId])
}

model Recommendation {
  id            String   @id @default(cuid())
  userId        String
  courseId      String
  score         Float    // Relevance score 0-1
  reason        String   // JSON with explanation
  isViewed      Boolean  @default(false)
  isClicked     Boolean  @default(false)
  isDismissed   Boolean  @default(false)
  createdAt     DateTime @default(now())
  expiresAt     DateTime

  @@unique([userId, courseId])
  @@index([userId])
  @@index([score])
}

// ============================================
// ANALYTICS ET REPORTING
// ============================================

model AnalyticsEvent {
  id          String   @id @default(cuid())
  eventType   String   // PAGE_VIEW, COURSE_START, LESSON_COMPLETE, QUIZ_SUBMIT, etc.
  userId      String?
  sessionId   String?
  courseId    String?
  lessonId    String?
  metadata    String?  // JSON with additional data
  createdAt   DateTime @default(now())

  @@index([eventType])
  @@index([userId])
  @@index([courseId])
  @@index([createdAt])
}

model DailyStats {
  id              String   @id @default(cuid())
  date            DateTime @unique
  activeUsers     Int      @default(0)
  newUsers        Int      @default(0)
  newEnrollments  Int      @default(0)
  completedLessons Int     @default(0)
  completedCourses Int     @default(0)
  quizAttempts    Int      @default(0)
  avgQuizScore    Float    @default(0)
  totalTimeSpent  Int      @default(0) // minutes

  @@index([date])
}
